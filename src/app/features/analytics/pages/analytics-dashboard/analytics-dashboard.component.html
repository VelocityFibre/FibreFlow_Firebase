<div class="analytics-dashboard-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>
        <mat-icon>analytics</mat-icon>
        Pole Analytics Dashboard
      </h1>
      <p>View and manage pole timeline reports</p>
    </div>
    <div class="header-actions">
      <button mat-icon-button (click)="refreshReports()" matTooltip="Refresh reports">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading()">
    <mat-card>
      <mat-card-content>
        <div class="loading-content">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading available reports...</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content" *ngIf="!loading()">
    <!-- Statistics Overview -->
    <div class="stats-overview">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-item">
            <mat-icon>analytics</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ dashboardStats().total }}</span>
              <span class="stat-label">Total Reports</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-item">
            <mat-icon color="primary">check_circle</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ dashboardStats().available }}</span>
              <span class="stat-label">Available</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-item">
            <mat-icon color="accent">table_chart</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ dashboardStats().csvReports }}</span>
              <span class="stat-label">CSV Reports</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-item">
            <mat-icon>cloud</mat-icon>
            <div class="stat-details">
              <span class="stat-value">{{ dashboardStats().availabilityRate }}%</span>
              <span class="stat-label">Availability Rate</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Filters and Search -->
    <mat-card class="filters-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>filter_list</mat-icon>
          Filter Reports
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="filters-grid">
          <mat-form-field appearance="outline">
            <mat-label>Search Pole Number</mat-label>
            <input
              matInput
              placeholder="Enter pole number..."
              (input)="onSearchChange($event)"
              [value]="searchTerm()"
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Data Source</mat-label>
            <mat-select [value]="selectedSource()" (valueChange)="selectedSource.set($event)">
              <mat-option value="all">All Sources</mat-option>
              <mat-option value="CSV">CSV</mat-option>
              <mat-option value="Firestore">Firestore</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Status</mat-label>
            <mat-select [value]="selectedStatus()" (valueChange)="selectedStatus.set($event)">
              <mat-option value="all">All Status</mat-option>
              <mat-option value="available">Available</mat-option>
              <mat-option value="generating">Generating</mat-option>
              <mat-option value="error">Error</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Reports Table -->
    <mat-card class="reports-table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>cell_tower</mat-icon>
          Pole Reports
          <mat-chip>{{ filteredReports().length }}</mat-chip>
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="table-container" *ngIf="filteredReports().length > 0">
          <table mat-table [dataSource]="filteredReports()" class="reports-table">
            <!-- Pole Number Column -->
            <ng-container matColumnDef="poleNumber">
              <th mat-header-cell *matHeaderCellDef>Pole Number</th>
              <td mat-cell *matCellDef="let report">
                <div class="pole-cell">
                  <mat-icon>cell_tower</mat-icon>
                  <span class="pole-number">{{ report.poleNumber }}</span>
                  <mat-chip
                    *ngIf="report.version === 'previous'"
                    color="accent"
                    class="version-chip"
                  >
                    Previous
                  </mat-chip>
                </div>
              </td>
            </ng-container>

            <!-- Last Generated Column -->
            <ng-container matColumnDef="lastGenerated">
              <th mat-header-cell *matHeaderCellDef>Last Generated</th>
              <td mat-cell *matCellDef="let report">
                <div class="date-cell">
                  <span class="date">{{ formatDate(report.lastGenerated) }}</span>
                  <mat-icon [color]="getStatusColor(report.status)">
                    {{ getStatusIcon(report.status) }}
                  </mat-icon>
                </div>
              </td>
            </ng-container>

            <!-- Summary Column -->
            <ng-container matColumnDef="summary">
              <th mat-header-cell *matHeaderCellDef>Summary</th>
              <td mat-cell *matCellDef="let report">
                <div class="summary-cell">
                  <div class="summary-item">
                    <mat-icon>assignment</mat-icon>
                    <span>{{ report.totalRecords }} records</span>
                  </div>
                  <div class="summary-item">
                    <mat-icon>water_drop</mat-icon>
                    <span>{{ report.totalDrops }} drops</span>
                  </div>
                  <div class="summary-item">
                    <mat-icon>people</mat-icon>
                    <span>{{ report.totalAgents }} agents</span>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Data Source Column -->
            <ng-container matColumnDef="dataSource">
              <th mat-header-cell *matHeaderCellDef>Source</th>
              <td mat-cell *matCellDef="let report">
                <mat-chip [color]="report.dataSource === 'CSV' ? 'primary' : 'accent'">
                  <mat-icon>{{ report.dataSource === 'CSV' ? 'table_chart' : 'cloud' }}</mat-icon>
                  {{ report.dataSource }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let report">
                <div class="actions-cell">
                  <button
                    mat-icon-button
                    (click)="viewPoleReport(report.poleNumber)"
                    matTooltip="View Report"
                    [disabled]="report.status !== 'available'"
                  >
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="generateReport(report.poleNumber)"
                    matTooltip="Regenerate Report"
                  >
                    <mat-icon>refresh</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    (click)="deleteReport(report.poleNumber)"
                    matTooltip="Delete Report"
                    color="warn"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
              class="clickable-row"
              (click)="viewPoleReport(row.poleNumber)"
            ></tr>
          </table>
        </div>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="filteredReports().length === 0 && !loading()">
          <mat-icon>analytics</mat-icon>
          <h3>No Reports Found</h3>
          <p *ngIf="searchTerm() || selectedSource() !== 'all' || selectedStatus() !== 'all'">
            Try adjusting your filters or search terms.
          </p>
          <p *ngIf="!searchTerm() && selectedSource() === 'all' && selectedStatus() === 'all'">
            No pole reports have been generated yet.
          </p>
          <button mat-button color="primary" (click)="refreshReports()">
            <mat-icon>refresh</mat-icon>
            Refresh Reports
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
