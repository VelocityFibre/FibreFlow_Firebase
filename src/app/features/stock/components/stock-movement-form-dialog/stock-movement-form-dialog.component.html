<h2 mat-dialog-title>New Stock Movement</h2>

<mat-dialog-content>
  <form [formGroup]="movementForm" class="movement-form">
    
    <!-- Stock Item Selection -->
    <section class="form-section">
      <h3>Item Information</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Stock Item</mat-label>
        <mat-select formControlName="itemId" required>
          <mat-option *ngFor="let item of data.stockItems" [value]="item.id">
            {{ getStockItemDisplay(item) }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="movementForm.get('itemId')?.hasError('required')">
          Stock item is required
        </mat-error>
      </mat-form-field>
      
      <!-- Display selected item details -->
      <div class="item-details" *ngIf="selectedItem()">
        <div class="detail-row">
          <span class="label">Current Stock:</span>
          <span class="value">{{ selectedItem()!.currentStock }} {{ selectedItem()!.unitOfMeasure }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Allocated:</span>
          <span class="value">{{ selectedItem()!.allocatedStock }} {{ selectedItem()!.unitOfMeasure }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Available:</span>
          <span class="value available">
            {{ selectedItem()!.currentStock - selectedItem()!.allocatedStock }} {{ selectedItem()!.unitOfMeasure }}
          </span>
        </div>
      </div>
    </section>
    
    <mat-divider></mat-divider>
    
    <!-- Movement Details -->
    <section class="form-section">
      <h3>Movement Details</h3>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Movement Type</mat-label>
          <mat-select formControlName="movementType" required>
            <mat-optgroup label="Incoming">
              <mat-option *ngFor="let type of incomingTypes" [value]="type">
                <mat-icon>add_circle</mat-icon>
                {{ movementTypeLabel(type) }}
              </mat-option>
            </mat-optgroup>
            <mat-optgroup label="Outgoing">
              <mat-option *ngFor="let type of outgoingTypes" [value]="type">
                <mat-icon>remove_circle</mat-icon>
                {{ movementTypeLabel(type) }}
              </mat-option>
            </mat-optgroup>
            <mat-optgroup label="Neutral">
              <mat-option *ngFor="let type of neutralTypes" [value]="type">
                <mat-icon>swap_horiz</mat-icon>
                {{ movementTypeLabel(type) }}
              </mat-option>
            </mat-optgroup>
          </mat-select>
          <mat-error *ngIf="movementForm.get('movementType')?.hasError('required')">
            Movement type is required
          </mat-error>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Movement Date</mat-label>
          <input matInput 
                 [matDatepicker]="datePicker" 
                 formControlName="movementDate" 
                 required>
          <mat-datepicker-toggle matIconSuffix [for]="datePicker"></mat-datepicker-toggle>
          <mat-datepicker #datePicker></mat-datepicker>
          <mat-error *ngIf="movementForm.get('movementDate')?.hasError('required')">
            Date is required
          </mat-error>
        </mat-form-field>
      </div>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Quantity</mat-label>
          <input matInput 
                 type="number" 
                 formControlName="quantity" 
                 (blur)="validateQuantity()"
                 required>
          <span matTextSuffix *ngIf="selectedItem()">{{ selectedItem()!.unitOfMeasure }}</span>
          <mat-error *ngIf="movementForm.get('quantity')?.hasError('required')">
            Quantity is required
          </mat-error>
          <mat-error *ngIf="movementForm.get('quantity')?.hasError('min')">
            Quantity must be greater than 0
          </mat-error>
        </mat-form-field>
        
        <mat-form-field appearance="outline">
          <mat-label>Unit Cost</mat-label>
          <span matTextPrefix>$&nbsp;</span>
          <input matInput 
                 type="number" 
                 formControlName="unitCost" 
                 required>
          <mat-error *ngIf="movementForm.get('unitCost')?.hasError('required')">
            Unit cost is required
          </mat-error>
          <mat-error *ngIf="movementForm.get('unitCost')?.hasError('min')">
            Unit cost must be 0 or greater
          </mat-error>
        </mat-form-field>
        
        <div class="total-cost">
          <span class="label">Total Cost:</span>
          <span class="value">{{ calculateTotalCost() | currency }}</span>
        </div>
      </div>
    </section>
    
    <!-- Project Fields (conditional) -->
    <section class="form-section" *ngIf="showProjectFields()">
      <mat-divider></mat-divider>
      <h3>Project Information</h3>
      
      <div class="form-row">
        <mat-form-field appearance="outline" *ngIf="movementForm.get('fromProjectId')?.hasValidators">
          <mat-label>From Project</mat-label>
          <mat-select formControlName="fromProjectId">
            <mat-option *ngFor="let project of data.projects" [value]="project.id">
              {{ getProjectDisplay(project) }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="movementForm.get('fromProjectId')?.hasError('required')">
            Source project is required
          </mat-error>
        </mat-form-field>
        
        <mat-form-field appearance="outline" *ngIf="movementForm.get('toProjectId')?.hasValidators">
          <mat-label>To Project</mat-label>
          <mat-select formControlName="toProjectId">
            <mat-option *ngFor="let project of data.projects" [value]="project.id">
              {{ getProjectDisplay(project) }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="movementForm.get('toProjectId')?.hasError('required')">
            Destination project is required
          </mat-error>
        </mat-form-field>
      </div>
    </section>
    
    <!-- Reference Fields -->
    <section class="form-section">
      <mat-divider></mat-divider>
      <h3>Reference Information</h3>
      
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Reference Type</mat-label>
          <mat-select formControlName="referenceType">
            <mat-option value="">None</mat-option>
            <mat-option *ngFor="let type of referenceTypes" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <mat-form-field appearance="outline" *ngIf="showReferenceFields()">
          <mat-label>Reference Number</mat-label>
          <input matInput formControlName="referenceNumber">
        </mat-form-field>
      </div>
    </section>
    
    <!-- Additional Information -->
    <section class="form-section">
      <mat-divider></mat-divider>
      <h3>Additional Information</h3>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Reason</mat-label>
        <input matInput formControlName="reason">
        <mat-error *ngIf="movementForm.get('reason')?.hasError('required')">
          Reason is required for this movement type
        </mat-error>
      </mat-form-field>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Notes</mat-label>
        <textarea matInput 
                  formControlName="notes" 
                  rows="3"
                  placeholder="Additional notes or comments...">
        </textarea>
      </mat-form-field>
    </section>
    
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()">Cancel</button>
  <button mat-raised-button 
          color="primary" 
          (click)="onSubmit()"
          [disabled]="movementForm.invalid">
    Create Movement
  </button>
</mat-dialog-actions>